name: Product Pipeline (CI/CD)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]
  workflow_dispatch:

env:
  AWS_REGION: eu-west-2
  ECR_REPOSITORY_API: meeting-intel-api
  ECR_REPOSITORY_UI: meeting-intel-ui
  ECS_CLUSTER: meeting-intel-cluster
  ECS_SERVICE_API: meeting-intel-api-service
  ECS_SERVICE_UI: meeting-intel-ui-service
  ECS_TASK_DEFINITION_API: meeting-intel-api
  ECS_TASK_DEFINITION_UI: meeting-intel-ui

jobs:
  code-test:
    name: 1. Code Test (Lints & Pytest)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic-dev

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          export PATH="$HOME/.local/bin:$PATH"
          poetry --version

      - name: Cache Poetry dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Install dependencies
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          poetry config virtualenvs.create false
          poetry install --no-root

      - name: Run Pytest & Lint
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export PYTHONPATH=$PYTHONPATH:.
          export LLM_PROVIDER=openai
          export BEDROCK_REGION=eu-west-2
          export BEDROCK_LLM_MODEL_ID=dummy
          export EMBED_PROVIDER=openai
          export OPENAI_API_KEY=sk-dummy-key-for-tests
          export DATABASE_URI=./data/test_lancedb
          export ENVIRONMENT=development
          poetry run pytest tests/ -v

  image-verify:
    name: 2. Image Verification
    needs: code-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Verify Docker Builds
        run: |
          docker build -f api_service/Dockerfile -t api-verify:local .
          docker build -f ui_service/Dockerfile -t ui-verify:local .

  infrastructure-check:
    name: 3. Infrastructure Check
    needs: image-verify
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify Cluster & Services
        run: |
          aws ecs describe-clusters --clusters ${{ env.ECS_CLUSTER }} --query 'clusters[0].status'
          aws ecs describe-services --cluster ${{ env.ECS_CLUSTER }} --services ${{ env.ECS_SERVICE_API }} ${{ env.ECS_SERVICE_UI }} --query 'services[*].status'

  deploy:
    name: 4. Build & Deploy to Production
    needs: [code-test, image-verify, infrastructure-check]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push API Image
        id: image-api
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f api_service/Dockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY_API:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_API:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY_API:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Build and Push UI Image
        id: image-ui
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -f ui_service/Dockerfile -t $ECR_REGISTRY/$ECR_REPOSITORY_UI:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY_UI:latest .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_UI:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY_UI:latest
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY_UI:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Update API Task Definition
        run: |
          aws ecs describe-task-definition --task-definition ${{ env.ECS_TASK_DEFINITION_API }} --query taskDefinition > task-def-api.json

      - name: Render API Task Definition
        id: task-def-api
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def-api.json
          container-name: api
          image: ${{ steps.image-api.outputs.image }}

      - name: Deploy API Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-api.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE_API }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      - name: Update UI Task Definition
        run: |
          aws ecs describe-task-definition --task-definition ${{ env.ECS_TASK_DEFINITION_UI }} --query taskDefinition > task-def-ui.json

      - name: Render UI Task Definition
        id: task-def-ui
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: task-def-ui.json
          container-name: ui
          image: ${{ steps.image-ui.outputs.image }}

      - name: Deploy UI Service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def-ui.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE_UI }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
